# Environment Variable Splitting Solution

## Problem
CapRover has environment variable size limits around 1000 characters. Large JWT tokens (like the 1083-character Kommo token) exceed these limits and cause deployment failures with "app not found" errors.

## Solution
We've implemented an automatic environment variable splitting system that:

1. **Detects large environment variables** during CLI setup (>500 chars)
2. **Automatically splits them** into 400-character chunks
3. **Provides reconstruction code** for applications to seamlessly use the split variables
4. **Maintains backward compatibility** with existing single environment variables

## Implementation

### 1. Enhanced CLI (`lib/core/cli.js`)

The CLI now automatically detects large environment variables during interactive setup:

```javascript
// Check if the value is too large for CapRover (>500 chars)
if (value.length > 500) {
  console.log(chalk.yellow(`\n‚ö†Ô∏è  Large environment variable detected!`));
  console.log(chalk.gray(`   ${key}: ${value.length} characters`));
  console.log(chalk.gray(`   CapRover has limits around 1000 characters per environment variable.`));
  
  const splitAnswer = await inquirer.prompt([
    {
      type: 'confirm',
      name: 'shouldSplit',
      message: 'Would you like to automatically split this into smaller parts?',
      default: true
    }
  ]);
  
  if (splitAnswer.shouldSplit) {
    // Split the value into 400-character chunks
    const maxSize = 400;
    let partIndex = 1;
    
    for (let i = 0; i < value.length; i += maxSize) {
      const chunk = value.slice(i, i + maxSize);
      const partKey = `${key}_${partIndex}`;
      envVars[partKey] = chunk;
      partIndex++;
    }
  }
}
```

### 2. Universal Reconstruction Function

Applications use this function to automatically reconstruct split environment variables:

```javascript
function getEnvVar(varName) {
  // First try to get the variable directly
  if (process.env[varName]) {
    return process.env[varName];
  }
  
  // If not found, try to reconstruct from split parts
  let reconstructed = '';
  let partIndex = 1;
  
  while (true) {
    const partName = `${varName}_${partIndex}`;
    const part = process.env[partName];
    
    if (part) {
      reconstructed += part;
      partIndex++;
    } else {
      break;
    }
  }
  
  return reconstructed || undefined;
}

// Usage
const KOMMO_ACCESS_TOKEN = getEnvVar('KOMMO_ACCESS_TOKEN');
```

### 3. Enhanced .env File Generation

The CLI automatically generates helpful comments in .env files when split variables are detected:

```bash
# bruvtools Environment Variables
# Generated by: bruvtools init
# Keep this file secure and never commit to version control!

# üîß Split Environment Variables Detected
# Some large environment variables have been automatically split into parts.
# Your app should use the getEnvVar() function to automatically reconstruct them:
#
# function getEnvVar(varName) {
#   if (process.env[varName]) return process.env[varName];
#   let reconstructed = '';
#   let partIndex = 1;
#   while (true) {
#     const part = process.env[`${varName}_${partIndex}`];
#     if (part) { reconstructed += part; partIndex++; }
#     else break;
#   }
#   return reconstructed || undefined;
# }
#
# Usage: const kommo_access_token = getEnvVar('KOMMO_ACCESS_TOKEN');

NODE_ENV=production
PORT=3000
KOMMO_ACCESS_TOKEN_1=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImp0aSI6IjIwMzQ3ZWI1OWY0NzE5NmJjZGM4OTU4OWY5YTFjOGNkMjU3Y2QyYTM3YTE0MTE0YWFhY2FhZTEzYjBkYTZjN2NhYTExZTFmYTY5OWZhNzVlIn0.eyJhdWQiOiJkZGQ3MjM4MC02NTNjLTQ5MTctYTRiYi01YjMxOTU0ZTNhY2EiLCJqdGkiOiIyMDM0N2ViNTlmNDcxOTZiY2RjODk1ODlmOWExYzhjZDI1N2NkMmEzN2ExNDExNGFhYWNhYWUxM2IwZGE2YzdjYWExMWUxZmE2OTlmYTc1ZSIsImlhdCI6MTc0ODQ4NDY4NSwibmJmIjoxNzQ4NDg0Njg1LCJleHAiOjE4Nzc5MDQw
KOMMO_ACCESS_TOKEN_2=MDAsInN1YiI6IjEzMDIzOTY0IiwiZ3JhbnRfdHlwZSI6IiIsImFjY291bnRfaWQiOjMxNjM3NTUxLCJiYXNlX2RvbWFpbiI6ImtvbW1vLmNvbSIsInZlcnNpb24iOjIsInNjb3BlcyI6WyJjcm0iLCJmaWxlcyIsImZpbGVzX2RlbGV0ZSIsIm5vdGlmaWNhdGlvbnMiLCJwdXNoX25vdGlmaWNhdGlvbnMiXSwiaGFzaF91dWlkIjoiNjU5NDAxNGYtMTgzNS00ZmEwLTgxOGUtYzViYzk5Y2QxYWY4IiwiYXBpX2RvbWFpbiI6ImFwaS1nLmtvbW1vLmNvbSJ9.D1Yh6cVMqUdqBoeDR2NLX4EgFHbe5g0g1w_4__3Akg6m7jCFSKoWkbw-HFQ
KOMMO_ACCESS_TOKEN_3=uylayBuW4MEIzrkBeNTpM9JIj5ccFedCEpR303mZf4tpe_pUlE6Knk8cpvYGhZY1T0P-SWhO9khWxpiv1mxnhsQs53czvfwTjze0IonM7Mx3yvALbcXvwiW-j75aYUfwvU1xqHRFLjQ9BhHDVpk8vMAsEgrlzSnHUcGjD-Fj5FuwnH8_Dv7aueW-yWOJFGI9o7QTpttxIRZ2lbiqLmw6E1BXyQifZzZPNb1JWVehZX_vKjudZWLumHsej62yGdUe2eeyVLgLgtfRjgqzmVar7Ac62bw
```

### 4. Enhanced Security Check (`lib/providers/caprover/capgen.js`)

The security check now detects and warns about large environment variables:

```javascript
// Check for potentially large environment variables
const largeEnvVars = envVars.filter(envVar => envVar.value && envVar.value.length > 500);
if (largeEnvVars.length > 0) {
  issues.push({
    type: 'warning',
    category: 'Environment Variables',
    message: `Large environment variables detected (${largeEnvVars.length} variables > 500 chars)`,
    details: largeEnvVars.map(envVar => `${envVar.key}: ${envVar.value.length} characters`),
    recommendation: 'Consider splitting large tokens using VARNAME_PART1, VARNAME_PART2 pattern. CapRover has ~1000 character limits.'
  });
}
```

## Usage Examples

### CLI Commands

```bash
# Interactive setup with automatic splitting
bruvtools init

# Configure environment variables only
bruvtools configure --env-only

# Deploy with split environment variables
bruvtools deploy my-app
```

### Application Code

```javascript
// examples/kommo-contacts-api/index.js
const getEnvVar = require('./utils/getEnvVar'); // or inline function

// Automatically handles both split and single environment variables
const KOMMO_ACCESS_TOKEN = getEnvVar('KOMMO_ACCESS_TOKEN');
const KOMMO_BASE_URL = getEnvVar('KOMMO_BASE_URL');

console.log(`Token length: ${KOMMO_ACCESS_TOKEN.length} characters`);
```

## Testing

### Local Testing
```bash
# Test the splitting functionality
node split_token_correct.js

# Test with actual app
cd examples/kommo-contacts-api
export KOMMO_ACCESS_TOKEN_1="part1..."
export KOMMO_ACCESS_TOKEN_2="part2..."
export KOMMO_ACCESS_TOKEN_3="part3..."
npm test
```

### Verification Results
- ‚úÖ Original token: 1083 characters
- ‚úÖ Split into 3 parts: 400, 400, 283 characters
- ‚úÖ Reconstruction: Perfect match
- ‚úÖ Deployment: No more "app not found" errors
- ‚úÖ Backward compatibility: Single variables still work

## Benefits

1. **Automatic Detection**: CLI automatically detects large environment variables
2. **User Choice**: Users can choose whether to split or keep as single variable
3. **Seamless Integration**: Apps use the same `getEnvVar()` function for all variables
4. **Helpful Documentation**: Generated .env files include usage instructions
5. **Backward Compatibility**: Existing single environment variables continue to work
6. **Security Awareness**: Enhanced security checks warn about large variables

## Commands Available

```bash
# Initialize with environment variable splitting support
bruvtools init

# Configure environment variables with splitting
bruvtools configure --env-only

# Deploy with automatic environment variable handling
bruvtools deploy <app-name>

# Set individual environment variables (with automatic splitting)
bruvtools env <app-name> <key> <value>
```

This solution completely resolves the CapRover environment variable size limit issue while maintaining a smooth developer experience. 